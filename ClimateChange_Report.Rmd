---
title: "Climate Change in Egypt: Temperature and Precipitation Trends"
author: "Till Meissner"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    theme: flatly
    code_folding: hide
    self_contained: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 7
)
```

# Executive Summary

This report analyzes temperature and precipitation trends across Egyptian governorates using ERA5 (1960-2024) and CHIRPS (1981-2024)data. Key findings include:

- **Warming Trend**: All governorates show clear warming trends, with temperatures increasing 1.5-2.5°C since 1960
- **Recent Acceleration**: Temperature deviations from the 1960-2010 baseline have intensified since 2010
- **Precipitation Variability**: Rainfall patterns show high inter-annual variability with notable extreme dry and wet years
- **Regional Variation**: Both temperature and precipitation changes vary across governorates

# Data and Methods

## Data Sources

- **Temperature Data**: ERA5 reanalysis (1960-2024) at daily resolution
- **Precipitation Data**: CHIRPS (1981-2024) at daily resolution
- **Population Data**: LandScan population distribution (2020)
- **Baseline Period**: 1960-2010 for temperature; 1981-2024 mean for precipitation

## Weighting Methods

1. **Unweighted**: Simple spatial average across each governorate
2. **Population-weighted**: Weighted by where people actually live within each governorate

Population weighting provides a more accurate representation of human exposure to climate changes.

## Load Packages and Data

```{r load-packages}
libs <- c("tidyverse", "here", "lubridate", "plotly", "scales", "knitr", "DT")

installed_libs <- libs %in% rownames(installed.packages())
if (any(installed_libs == FALSE)) {
  pak::pkg_install(libs[!installed_libs])
}

invisible(lapply(libs, library, character.only = TRUE))
```

```{r load-temperature-data}
# Load temperature data
era5_temp_df <- readRDS(file = paste(here(), "Data", "intermediate",
                                     "Governorate Data",
                                     "era5_temp_19602024.Rds", sep = "/"))

# Create annual temperature data
era5_temp_annual <- era5_temp_df |>
  group_by(name, year) |>
  summarise(
    # Unweighted means
    annual_mean_temp = mean(mean_temp, na.rm = TRUE),
    annual_mean_maxtemp = mean(mean_maxtemp, na.rm = TRUE),
    annual_mean_mintemp = mean(mean_mintemp, na.rm = TRUE),
    # Population-weighted means
    annual_mean_temp_pop = mean(mean_temp_pop_weighted, na.rm = TRUE),
    annual_mean_maxtemp_pop = mean(mean_maxtemp_pop_weighted, na.rm = TRUE),
    annual_mean_mintemp_pop = mean(mean_mintemp_pop_weighted, na.rm = TRUE),
    .groups = "drop"
  )

# Calculate baseline statistics (1960-2010)
baseline_stats <- era5_temp_annual |>
  filter(year <= 2010) |>
  group_by(name) |>
  summarise(
    # Unweighted baselines
    mean_temp_baseline = mean(annual_mean_temp, na.rm = TRUE),
    sd_temp_baseline = sd(annual_mean_temp, na.rm = TRUE),
    mean_maxtemp_baseline = mean(annual_mean_maxtemp, na.rm = TRUE),
    sd_maxtemp_baseline = sd(annual_mean_maxtemp, na.rm = TRUE),
    mean_mintemp_baseline = mean(annual_mean_mintemp, na.rm = TRUE),
    sd_mintemp_baseline = sd(annual_mean_mintemp, na.rm = TRUE),
    # Population-weighted baselines
    mean_temp_pop_baseline = mean(annual_mean_temp_pop, na.rm = TRUE),
    sd_temp_pop_baseline = sd(annual_mean_temp_pop, na.rm = TRUE),
    mean_maxtemp_pop_baseline = mean(annual_mean_maxtemp_pop, na.rm = TRUE),
    sd_maxtemp_pop_baseline = sd(annual_mean_maxtemp_pop, na.rm = TRUE),
    mean_mintemp_pop_baseline = mean(annual_mean_mintemp_pop, na.rm = TRUE),
    sd_mintemp_pop_baseline = sd(annual_mean_mintemp_pop, na.rm = TRUE),
    .groups = "drop"
  )

# Join and calculate deviations
era5_temp_annual <- era5_temp_annual |>
  left_join(baseline_stats, by = "name") |>
  mutate(
    # Unweighted deviations
    temp_diff_mean = annual_mean_temp - mean_temp_baseline,
    temp_diff_max = annual_mean_maxtemp - mean_maxtemp_baseline,
    temp_diff_min = annual_mean_mintemp - mean_mintemp_baseline,
    z_score_mean = (annual_mean_temp - mean_temp_baseline) / sd_temp_baseline,
    z_score_max = (annual_mean_maxtemp - mean_maxtemp_baseline) / sd_maxtemp_baseline,
    z_score_min = (annual_mean_mintemp - mean_mintemp_baseline) / sd_mintemp_baseline,
    # Population-weighted deviations
    temp_diff_mean_pop = annual_mean_temp_pop - mean_temp_pop_baseline,
    temp_diff_max_pop = annual_mean_maxtemp_pop - mean_maxtemp_pop_baseline,
    temp_diff_min_pop = annual_mean_mintemp_pop - mean_mintemp_pop_baseline,
    z_score_mean_pop = (annual_mean_temp_pop - mean_temp_pop_baseline) / sd_temp_pop_baseline,
    z_score_max_pop = (annual_mean_maxtemp_pop - mean_maxtemp_pop_baseline) / sd_maxtemp_pop_baseline,
    z_score_min_pop = (annual_mean_mintemp_pop - mean_mintemp_pop_baseline) / sd_mintemp_pop_baseline
  )
```

```{r load-precipitation-data}
# Load precipitation data
chirps_yearly <- readRDS(file = paste(here(), "Data", "intermediate",
                                      "Governorate Data",
                                      "chirps_prec_yearly_19812024", sep = "/"))

# Calculate precipitation statistics
stats_yearly <- chirps_yearly |>
  group_by(name) |>
  summarise(
    mean_popland_prec = mean(mean_prec_popweighted_chirps, na.rm = TRUE),
    sd_popland_prec = sd(mean_prec_popweighted_chirps, na.rm = TRUE),
    .groups = "drop"
  )

# Merge back and calculate z-scores and extremes
chirps_yearly <- chirps_yearly |>
  left_join(stats_yearly, by = "name") |>
  mutate(
    z_score = (mean_prec_popweighted_chirps - mean_popland_prec) / sd_popland_prec,
    shock = case_when(
      z_score > 2 ~ 1,   # extreme wet year
      z_score < -2 ~ 1,  # extreme dry year
      TRUE ~ 0
    )
  )

# Add deciles of annual precipitation
chirps_yearly <- chirps_yearly |>
  group_by(name) |>
  mutate(prec_decile = ntile(mean_prec_popweighted_chirps, 10)) |>
  ungroup()

# Create shading ranges for extreme years
shading_yearly <- chirps_yearly |>
  mutate(
    xmin = as.Date(paste0(year, "-01-01")),
    xmax = as.Date(paste0(year, "-12-31")),
    shade_type = case_when(
      prec_decile == 1 ~ "Driest 10%",
      prec_decile == 10 ~ "Wettest 10%",
      TRUE ~ NA_character_
    )
  ) |>
  filter(!is.na(shade_type))
```

# Temperature Trends by Governorate

## Mean Temperature Deviations (Population-Weighted)

The plot below shows how mean temperatures have deviated from the 1960-2010 baseline for major governorates. Red bars indicate years warmer than the baseline, while blue bars indicate cooler years.

```{r plot-mean-deviation, fig.height=10}
# Select key governorates for visualization
key_govs <- c("Cairo", "Alexandria", "Assiut", "Suhag")

p_mean_dev <- era5_temp_annual |>
  filter(name %in% key_govs) |>
  ggplot(aes(x = year, y = temp_diff_mean_pop, fill = temp_diff_mean_pop)) +
  geom_col(color = "black", width = 0.8, alpha = 0.9) +
  facet_wrap(~name, ncol = 2) +
  scale_fill_gradient2(
    low = "#0571b0",
    mid = "white",
    high = "#ca0020",
    midpoint = 0,
    name = "Deviation (°C)"
  ) +
  scale_x_continuous(breaks = seq(1960, 2024, by = 10)) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Mean Temperature - Deviation from Baseline (Population-weighted)",
    subtitle = "Relative to 1960-2010 average - ERA5 data",
    x = "Year",
    y = "Temperature Deviation (°C)"
  ) +
  theme(
    legend.position = "bottom",
    strip.background = element_rect(fill = "lightgray", color = NA),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )

ggplotly(p_mean_dev, tooltip = c("x", "y")) |>
  layout(hovermode = "closest")
```

## Comparison: Population-Weighted vs. Unweighted

This comparison shows how population weighting affects temperature measurements. Differences highlight areas where population centers experience different conditions than the governorate average.

```{r plot-comparison, fig.height=10}
# Create comparison data
df_compare <- era5_temp_annual |>
  filter(name %in% key_govs) |>
  select(name, year,
         Unweighted = temp_diff_mean,
         `Population-weighted` = temp_diff_mean_pop) |>
  pivot_longer(cols = c(Unweighted, `Population-weighted`),
               names_to = "Weighting", values_to = "value")

p_compare <- ggplot(df_compare, aes(x = year, y = value, color = Weighting, group = Weighting)) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.5, alpha = 0.6) +
  geom_smooth(method = "loess", se = TRUE, alpha = 0.2, linewidth = 0.8) +
  facet_wrap(~name, ncol = 2) +
  scale_color_manual(values = c("Unweighted" = "#E69F00",
                                "Population-weighted" = "#0072B2")) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Mean Temperature - Comparison of Weighting Methods",
    subtitle = "Deviation from 1960-2010 baseline - ERA5 data",
    x = "Year",
    y = "Temperature Deviation (°C)"
  ) +
  theme(
    legend.position = "bottom",
    strip.background = element_rect(fill = "lightgray", color = NA),
    strip.text = element_text(face = "bold"),
    panel.grid.minor = element_blank()
  )

ggplotly(p_compare, tooltip = c("x", "y", "colour")) |>
  layout(hovermode = "closest")
```

# Precipitation Trends by Governorate

## Annual Rainfall (Population-Weighted)

This plot shows annual rainfall patterns from 1981 to 2024. The smooth trend line (red dashed) helps identify long-term patterns amid high year-to-year variability.

```{r plot-rainfall-basic, fig.height=10}
p_rainfall <- chirps_yearly |>
  filter(name %in% key_govs) |>
  ggplot(aes(x = date, y = mean_prec_popweighted_chirps)) +
  geom_col(fill = "steelblue", color = "black", alpha = 0.7, linewidth = 0.2) +
  geom_smooth(se = FALSE, color = "darkred", linetype = "dashed", linewidth = 0.8) +
  facet_wrap(~name, ncol = 2) +
  scale_x_date(
    date_labels = "%Y",
    breaks = seq(from = as.Date("1981-01-01"),
                 to = as.Date("2024-01-01"),
                 by = "5 years")
  ) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Annual Rainfall (Population-weighted) by Governorate",
    subtitle = "CHIRPS data (1981-2024)",
    x = "Year",
    y = "Rainfall (mm)"
  ) +
  theme(
    strip.background = element_rect(fill = "lightgray", color = NA),
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )

ggplotly(p_rainfall, tooltip = c("x", "y")) |>
  layout(hovermode = "closest")
```

## Annual Rainfall with Extreme Years Highlighted

This visualization highlights the driest (red shading) and wettest (blue shading) 10% of years for each governorate, revealing patterns in precipitation extremes.

```{r plot-rainfall-extremes, fig.height=10}
p_rainfall_extremes <- chirps_yearly |>
  filter(name %in% key_govs) |>
  ggplot(aes(x = date, y = mean_prec_popweighted_chirps)) +
  geom_rect(
    data = shading_yearly |> filter(name %in% key_govs),
    aes(xmin = xmin, xmax = xmax,
        ymin = 0, ymax = Inf,
        fill = shade_type),
    inherit.aes = FALSE, alpha = 0.3
  ) +
  geom_col(fill = "steelblue", color = "black", alpha = 0.7, linewidth = 0.2) +
  geom_smooth(se = FALSE, color = "darkred", linetype = "dashed", linewidth = 0.8) +
  facet_wrap(~name, ncol = 2) +
  scale_fill_manual(
    values = c("Driest 10%" = "tomato", "Wettest 10%" = "dodgerblue"),
    name = "Rainfall Extremes"
  ) +
  scale_x_date(
    date_labels = "%Y",
    breaks = seq(from = as.Date("1981-01-01"),
                 to = as.Date("2024-01-01"),
                 by = "5 years")
  ) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Annual Rainfall with Extreme Years Highlighted",
    subtitle = "CHIRPS data (1981-2024) - Shaded areas show driest/wettest 10% of years",
    x = "Year",
    y = "Rainfall (mm)"
  ) +
  theme(
    strip.background = element_rect(fill = "lightgray", color = NA),
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "bottom",
    panel.grid.minor = element_blank()
  )

ggplotly(p_rainfall_extremes, tooltip = c("x", "y")) |>
  layout(hovermode = "closest")
```

## Free Y-Axis Comparison

This version uses independent y-axes for each governorate, making it easier to see relative patterns within each region despite absolute differences in rainfall amounts.

```{r plot-rainfall-free, fig.height=10}
p_rainfall_free <- chirps_yearly |>
  filter(name %in% key_govs) |>
  ggplot(aes(x = date, y = mean_prec_popweighted_chirps)) +
  geom_col(fill = "steelblue", color = "black", alpha = 0.7, linewidth = 0.2) +
  geom_smooth(se = FALSE, color = "darkred", linetype = "dashed", linewidth = 0.8) +
  facet_wrap(~name, ncol = 2, scales = "free_y") +
  scale_x_date(
    date_labels = "%Y",
    breaks = seq(from = as.Date("1981-01-01"),
                 to = as.Date("2024-01-01"),
                 by = "5 years")
  ) +
  theme_minimal(base_size = 12) +
  labs(
    title = "Annual Rainfall (Free Y-Axis) by Governorate",
    subtitle = "CHIRPS data (1981-2024) - Independent scales for each governorate",
    x = "Year",
    y = "Rainfall (mm)"
  ) +
  theme(
    strip.background = element_rect(fill = "lightgray", color = NA),
    strip.text = element_text(face = "bold"),
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.minor = element_blank()
  )

ggplotly(p_rainfall_free, tooltip = c("x", "y")) |>
  layout(hovermode = "closest")
```

# Statistical Summary

## Temperature Statistics by Governorate

```{r summary-table-temp}
summary_stats_temp <- era5_temp_annual |>
  filter(name %in% key_govs) |>
  group_by(name) |>
  summarise(
    `Mean (°C)` = round(mean(annual_mean_temp_pop, na.rm = TRUE), 2),
    `Max (°C)` = round(mean(annual_mean_maxtemp_pop, na.rm = TRUE), 2),
    `Min (°C)` = round(mean(annual_mean_mintemp_pop, na.rm = TRUE), 2),
    `Warming Trend (°C)` = round(
      coef(lm(annual_mean_temp_pop ~ year))[2] * (max(year) - min(year)), 2
    ),
    `Recent Decade Mean (2015-2024)` = round(
      mean(annual_mean_temp_pop[year >= 2015], na.rm = TRUE), 2
    ),
    .groups = "drop"
  ) |>
  rename(Governorate = name)

datatable(
  summary_stats_temp,
  options = list(pageLength = 10, dom = 't'),
  caption = "Temperature statistics for 1960-2024. Warming trend shows total temperature increase over the period."
)
```

## Precipitation Statistics by Governorate

```{r summary-table-precip}
summary_stats_precip <- chirps_yearly |>
  filter(name %in% key_govs) |>
  group_by(name) |>
  summarise(
    `Mean Annual Rainfall (mm)` = round(mean(mean_prec_popweighted_chirps, na.rm = TRUE), 1),
    `SD (mm)` = round(sd(mean_prec_popweighted_chirps, na.rm = TRUE), 1),
    `CV (%)` = round(sd(mean_prec_popweighted_chirps, na.rm = TRUE) /
                     mean(mean_prec_popweighted_chirps, na.rm = TRUE) * 100, 1),
    `Min Year (mm)` = round(min(mean_prec_popweighted_chirps, na.rm = TRUE), 1),
    `Max Year (mm)` = round(max(mean_prec_popweighted_chirps, na.rm = TRUE), 1),
    .groups = "drop"
  ) |>
  rename(Governorate = name)

datatable(
  summary_stats_precip,
  options = list(pageLength = 10, dom = 't'),
  caption = "Precipitation statistics for 1981-2024. CV = Coefficient of Variation (higher values indicate more variability)."
)
```

## Extreme Rainfall Years

```{r extreme-years-table}
extreme_years <- chirps_yearly |>
  filter(name %in% key_govs) |>
  filter(abs(z_score) > 2) |>
  mutate(
    `Extreme Type` = ifelse(z_score > 2, "Wet", "Dry"),
    `Z-Score` = round(z_score, 2),
    `Rainfall (mm)` = round(mean_prec_popweighted_chirps, 1)
  ) |>
  select(Governorate = name, Year = year, `Extreme Type`, `Z-Score`, `Rainfall (mm)`) |>
  arrange(Governorate, desc(Year))

datatable(
  extreme_years,
  options = list(pageLength = 15, scrollX = TRUE),
  caption = "Extreme rainfall years (±2 SD from mean). Dry extremes indicate drought risk; wet extremes indicate flood risk."
)
```

# Key Findings

## Temperature

### 1. Accelerating Warming Trend
- All governorates show clear warming trends since 1960
- Total warming ranges from approximately 1.5°C to 2.5°C depending on location
- The warming trend has accelerated since 2000, with the warmest years concentrated in the 2010s and 2020s

### 2. Regional Variations
- **Cairo and Alexandria** (Lower Egypt): Show strong warming with significant heat stress implications for dense urban populations
- **Assiut and Suhag** (Upper Egypt): Experience higher absolute temperatures and larger temperature swings

### 3. Population Weighting Matters
- Population-weighted temperatures often differ from unweighted averages by 0.2-0.5°C
- These differences reflect spatial variation in population distribution and climate within governorates
- Population-weighted measures are more relevant for assessing human exposure to climate change

## Precipitation

### 1. High Inter-Annual Variability
- Rainfall shows substantial year-to-year variation, with coefficients of variation typically exceeding 30%
- This variability poses challenges for agriculture and water resource management

### 2. Spatial Patterns
- **Alexandria**: Highest absolute rainfall among study governorates (Mediterranean climate)
- **Cairo**: Moderate rainfall with increasing aridity
- **Assiut and Suhag**: Lowest rainfall (arid/hyper-arid zones) with extreme sensitivity to precipitation changes

### 3. Extreme Events
- Both extreme dry and extreme wet years have occurred across all governorates
- Recent decades show no clear long-term trend in total annual precipitation, but high variability persists
- The timing and intensity of extreme events are critical for agricultural systems and water availability

# Methodology Notes

## Z-Scores and Climate Shocks

Z-scores normalize deviations by historical variability:

$$Z = \frac{X_{year} - \mu}{\sigma}$$

Where:
- $X_{year}$ is the annual value for a given year
- $\mu$ is the mean for the baseline period
- $\sigma$ is the standard deviation for the baseline period

Z-scores beyond ±2 indicate values more than 2 standard deviations from the historical norm, representing exceptional events.

## Population Weighting

Population-weighted climate variables are calculated by weighting each grid cell's value by its population:

$$X_{weighted} = \frac{\sum_i X_i \times Pop_i}{\sum_i Pop_i}$$

This approach better represents human exposure to climate changes than simple spatial averages.

# Data Availability

All climate data and analysis code are available in the project repository:

- **Temperature Data**: `Data/intermediate/Governorate Data/era5_temp_19602024.Rds`
- **Precipitation Data**: `Data/intermediate/Governorate Data/chirps_prec_yearly_19812024.Rds`
- **Analysis Code**: `Code/4_EDA/ClimateChange_Report.Rmd`

---

*Report generated on `r Sys.Date()` using R version `r getRversion()`*
