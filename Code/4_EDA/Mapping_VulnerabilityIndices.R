#Inv. Distance Weighting to create Vulnerability Indices
#Heat Stress,Drought Stress, Heat & Drought Stress
#Read in Packages --------------------------------------------------------
#Define packages used
libs <- c("tidyverse","naniar","here","devtools","leaflet",
          "terra","raster","geodata","sf","exactextractr",
          "stdidx","gstat","ggmap")

#install missing libraries
installed_libs <- libs %in% rownames(installed.packages())
if (any(installed_libs == FALSE)){
  install.packages(libs[!installed_libs])
}

#load libraries
invisible(lapply(libs,library,character.only = TRUE))

#Load Google Key
google_key <- readLines(paste(here(),"google_key.txt",sep = "/"))
register_google(key = google_key)

# Showing Spatial Variation in Indices-------------------------------------------
#Read in Vulnerability Indices
hh_indices <- readRDS(file = paste(here(),"Data",
                      "Households","hh_indices.Rds",sep = "/"))

#Read in HH Data
hh_data <- haven::read_dta(file = paste(here(),"Data",
                      "Households","hh_data_v12112025.dta",sep = "/"))

#join together
hh_all <- hh_indices |>
  left_join(hh_data,by = c("hhid","agglom_id"))

#add shapefile
hh_data_imputedgps <- readRDS(file = paste(here(),"Data",
                        "hhdata_imputedgps_fullsample.rds",sep = "/"))

# Convert to sf object
hh_sf <- hh_data_imputedgps |>
  #filter out the 208 households without GPS location (imputation not possible)
  filter(!is.na(hh_gpslongitude_imputed),
         !is.na(hh_gpslatitude_imputed)) |>
  #turn into SF object
  st_as_sf(coords = c("hh_gpslongitude_imputed", "hh_gpslatitude_imputed"),
           crs = 4326, remove = FALSE) |>
  dplyr::select(hhid,agglom_id)

#join
hh_sf_joined <- hh_sf |>
  left_join(hh_indices,by = c("hhid","agglom_id"))

#Egypt GOV. shapefile
egypt_hdx <- st_read(paste(here(),
                           "Data","Shapefiles","HDX_Egypt",
                           "egy_admbnda_adm1_capmas_20170421.shp",sep = "/"))

egypt_2gov <- egypt_hdx |> filter(ADM1_EN %in% c("Suhag","Assiut"))

####Load Background Map####
# Define bounding box
bbox <- st_bbox(egypt_2gov)

# Get Google basemap
bg_map <- get_googlemap(
  center = c(lon = mean(c(bbox["xmin"], bbox["xmax"])),
             lat = mean(c(bbox["ymin"], bbox["ymax"]))),
  zoom = 11,
  maptype = "satellite"  # or "roadmap", "terrain", "hybrid"
)

#get asyut
asyut_coords <- c(lon = 31.18368, lat = 27.18096)

asyut_map <- get_googlemap(
  center = asyut_coords,
  zoom = 11,
  maptype = "satellite"  # "roadmap", "terrain", "hybrid", or "satellite"
)

ggmap(asyut_map)

####Heat Stress Index####
#####Leaflet Map#####
hh_sf_joined |>
  filter(!is.na(heat_stress_index)) |>
  leaflet() |>
  addProviderTiles(providers$Esri.WorldImagery) |>
  addCircleMarkers(
    lng = ~st_coordinates(geometry)[,1],
    lat = ~st_coordinates(geometry)[,2],
    radius = 4,
    color = ~colorNumeric("viridis", heat_stress_index)(heat_stress_index),
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste("Heat stress index:", heat_stress_index)
  ) |>
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", hh_sf_joined$heat_stress_index),
    values = hh_sf_joined$heat_stress_index,
    title = "Heat Stress Index"
  )




#####Static Map####
heatstress_map <- ggmap(asyut_map) +
  geom_sf(
    data = hh_sf_joined |> filter(!is.na(heat_stress_index )),
    inherit.aes = FALSE,
    aes(color = heat_stress_index ),
    size = 2
  ) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = mean(hh_sf_joined$heat_stress_index  , na.rm = TRUE),
    name = "Heat Stress Index"
  ) +
  labs(
    title = "Household Heat Stress Index around Asyut"
  ) +
  theme_minimal() +
  theme(legend.position = "bottom")

#drought stress map
heatstress_map


#####Interpolation#####
pts <- hh_sf_joined |>
  filter(!is.na(drought_stress_index_comb_15_24))

pts_sp <- as(pts, "Spatial")

# Create interpolation grid (resolution can be adjusted)
grid <- raster(pts_sp, resolution = 0.01)  # ~1km depending on CRS

# IDW model
g <- gstat::gstat(formula = drought_stress_index_comb_15_24 ~ 1, data = pts_sp,
                  nmax = 7, set = list(idp = 2))
idw_result <- interpolate(grid, g)

#Egypt GOV. shapefile
egypt_hdx <- st_read(paste(here(),
                           "Data","Shapefiles","HDX_Egypt",
                           "egy_admbnda_adm1_capmas_20170421.shp",sep = "/"))

# Filter the two governorates
egypt_2gov <- egypt_hdx |>
  filter(ADM1_EN %in% c("Assiut","Suhag"))

# Ensure CRS matches raster
if (st_crs(egypt_2gov) != crs(idw_result)) {
  egypt_2gov <- st_transform(egypt_2gov, crs(idw_result))
}

# Plot IDW raster
plot(idw_result)

# Add vector boundary on top
plot(vect(egypt_2gov), add = TRUE, border = "red", lwd = 2)

####ESI Drought Stress Index####
#####Static Map####
hh_sf_joined |>
  filter(!is.na(drought_stress_index_esi)) |>
  ggplot()+
  geom_sf(aes(colour = drought_stress_index_esi))


droughtstress_map <- ggmap(asyut_map) +
  geom_sf(
    data = hh_sf_joined |> filter(!is.na(drought_stress_index_esi)),
    inherit.aes = FALSE,
    aes(color = drought_stress_index_esi),
    size = 1
  ) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = mean(hh_sf_joined$drought_stress_index_esi, na.rm = TRUE),
    name = "Drought Stress Index: ESI based"
  ) +
  labs(
    title = "Household Drought Stress Index around Assiut",
    x = "", y = ""
  ) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "black"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom"
  )

#drought stress map
droughtstress_map

#####Leaflet Map#####
hh_sf_joined |>
  filter(!is.na(drought_stress_index_esi)) |>
  leaflet() |>
  addProviderTiles(providers$Esri.WorldImagery) |>
  addCircleMarkers(
    lng = ~st_coordinates(geometry)[,1],
    lat = ~st_coordinates(geometry)[,2],
    radius = 4,
    color = ~colorNumeric("viridis", drought_stress_index_esi)(drought_stress_index_esi),
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste("Drought stress index:", drought_stress_index_esi)
  ) |>
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", hh_sf_joined$drought_stress_index_esi),
    values = hh_sf_joined$drought_stress_index_esi,
    title = "Drought Stress Index"
  )

####Heat & Drought Stress Index####
#####Leaflet Map####
hh_sf_joined |>
  filter(!is.na(heatdrought_stress_index)) |>
  leaflet() |>
  addProviderTiles(providers$Esri.WorldImagery) |>
  addCircleMarkers(
    lng = ~st_coordinates(geometry)[, 1],
    lat = ~st_coordinates(geometry)[, 2],
    radius = 4,
    color = ~colorNumeric("viridis", heatdrought_stress_index)(heatdrought_stress_index),
    fillOpacity = 0.8,
    stroke = FALSE,
    popup = ~paste0(
      "<b>HHID:</b> ", hhid, "<br>",
      "<b>Heat-Drought Stress Index:</b> ", round(heatdrought_stress_index, 2)
    )
  ) |>
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", hh_sf_joined$heatdrought_stress_index),
    values = hh_sf_joined$heatdrought_stress_index,
    title = "Heat-Drought Stress Index"
  )

#####Static Map####
######Assiut#####
asyut_coords <- c(lon = 31.18368, lat = 27.18096)

# Create an sf point for Assiut
asyut_point <- st_point(asyut_coords) |>
  st_sfc(crs = 4326) |>                      # WGS84
  st_transform(32636)                        # project to UTM Zone 36N (for Egypt, meters)

# Create 20 km buffer (20,000 meters)
asyut_buffer <- st_buffer(asyut_point, dist = 30000)

# Transform household data to same CRS for spatial filtering
hh_sf_joined_utm <- hh_sf_joined |>
  st_transform(32636)

# Filter points within 20 km of Assiut
hh_near_assyut <- hh_sf_joined_utm[asyut_buffer, ] |>
  st_transform(4326)                         # back to lon/lat for plotting

# Map
heatdroughtstress_map_assiut <- ggmap(asyut_map) +
  geom_sf(
    data = hh_near_assyut |> filter(!is.na(heatdrought_stress_index_20_24)),
    inherit.aes = FALSE,
    aes(color = heatdrought_stress_index_20_24),
    size = 1
  ) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = mean(hh_near_assyut$heatdrought_stress_index_20_24, na.rm = TRUE),
    name = "Heat & Drought Stress Index (2020-2024)"
  ) +
  labs(
    title = "Household Heat & Drought Stress Index",
    subtitle = "Households within 30 km of Asyut City",
    x = "", y = ""
  ) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "black"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom"
  )

heatdroughtstress_map_assiut

######Suhag#####
# Coordinates of Suhag (Sohag)
suhag_coords <- c(lon = 31.6948, lat = 26.5560)

suhag_map <- get_googlemap(
  center = suhag_coords,
  zoom = 11,
  maptype = "satellite"  # "roadmap", "terrain", "hybrid", or "satellite"
)

ggmap(suhag_map)

# Create an sf point for Suhag
suhag_point <- st_point(suhag_coords) |>
  st_sfc(crs = 4326) |>                      # WGS84
  st_transform(32636)                        # project to UTM Zone 36N (for Egypt, meters)

# Create 30 km buffer (30,000 meters)
suhag_buffer <- st_buffer(suhag_point, dist = 30000)

# Transform household data to same CRS for spatial filtering
hh_sf_joined_utm <- hh_sf_joined |>
  st_transform(32636)

# Filter points within 30 km of Suhag
hh_near_suhag <- hh_sf_joined_utm[suhag_buffer, ] |>
  st_transform(4326)                         # back to lon/lat for plotting

# Map
heatdroughtstress_map_suhag <- ggmap(suhag_map) +
  geom_sf(
    data = hh_near_suhag |> filter(!is.na(heatdrought_stress_index)),
    inherit.aes = FALSE,
    aes(color = heatdrought_stress_index),
    size = 1
  ) +
  scale_color_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = mean(hh_near_suhag$heatdrought_stress_index, na.rm = TRUE),
    name = "Heat & Drought Stress Index"
  ) +
  labs(
    title = "Household Heat & Drought Stress Index",
    subtitle = "Households within 30km of Suhag City",
    x = "", y = ""
  ) +
  theme_minimal() +
  theme(
    panel.background = element_rect(fill = "black"),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    legend.position = "bottom"
  )

heatdroughtstress_map_suhag
