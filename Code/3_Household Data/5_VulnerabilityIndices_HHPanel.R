#Inv. Distance Weighting to create Vulnerability Indices
#Heat Stress,Drought Stress, Heat & Drought Stress
#Read in Packages --------------------------------------------------------
#remotes::install_github("graemeblair/stdidx")

#Define packages used
libs <- c("tidyverse","naniar","here","devtools",
          "terra","raster","geodata","sf","exactextractr",
          "stdidx","gstat","ggmap","labelled")

#install missing libraries
installed_libs <- libs %in% rownames(installed.packages())
if (any(installed_libs == FALSE)){
  install.packages(libs[!installed_libs])
}

#load libraries
invisible(lapply(libs,library,character.only = TRUE))

# Load Data ---------------------------------------------------------------
hh_data <- haven::read_dta(file = paste(here(),"Data","final",
                                  "hh_data.dta",sep = "/"))

# Creating Indices --------------------------------------------------------
hh_indices <- hh_data |>
#1.Standardising variables
  mutate(across(c(temp_mean_growth_summer,temp_mean_growth_winter,
                  matches("(_pre|_20152024|_20202024)$|distance_nile_metres|distance_waterway_metres")),
                \(x) as.numeric(scale(x)),
                .names = "z_{.col}")) |>
#Pretreatment indices -------------------------------------------------------
mutate(
  ####Pre 1. Heat Stress Index ####
  heat_stress_index_pre = idx_invcov(
    z_temp_shockdays_summer_pre,
    z_temp_shockdays_winter_pre,
    z_temp_avgmean_summer_pre,
    z_temp_avgmean_winter_pre,
    z_temp_heatwave_days_n_pre,
    z_temp_wdays30_n_pre,
    na.rm = TRUE
  ),
  ####Pre 2. Combined Heat Stress Index - Temp. + UTCI ####
  heat_stress_index_comb_pre = idx_invcov(
    z_temp_shockdays_summer_pre,
    z_temp_shockdays_winter_pre,
    z_temp_avgmean_summer_pre,
    z_temp_avgmean_winter_pre,
    z_temp_heatwave_days_n_pre,
    z_temp_wdays30_n_pre,
    z_utci_shockdays_summer_pre,
    z_utci_shockdays_winter_pre,
    z_utci_heatstress_n_pre,
    na.rm = TRUE
  ),
  ####Pre 3.Drought Stress Index – ESI only ####
  drought_stress_index_esi_pre = idx_invcov(
    z_esi_mdrought_summer_pre,
    z_esi_mdrought_winter_pre,
    z_esi_sdrought_summer_pre,
    z_esi_sdrought_winter_pre,
    na.rm = TRUE
  ),
  ####Pre 4.Ext. Drought Stress Index – ESI + NDVI ####
  drought_stress_index_comb_pre = idx_invcov(
    z_esi_mdrought_summer_pre,
    z_esi_mdrought_winter_pre,
    z_esi_sdrought_summer_pre,
    z_esi_sdrought_winter_pre,
    z_ndvi_shockmonths_summer_pre,
    z_ndvi_shockmonths_winter_pre,
    na.rm = TRUE
  ),
  ####Pre 5. Heat + Drought (Temp + ESI) ####
  heatdrought_stress_index_pre = idx_invcov(
    z_temp_shockdays_summer_pre,
    z_temp_shockdays_winter_pre,
    z_temp_avgmean_summer_pre,
    z_temp_avgmean_winter_pre,
    z_temp_heatwave_days_n_pre,
    z_temp_wdays30_n_pre,
    z_esi_mdrought_summer_pre,
    z_esi_mdrought_winter_pre,
    z_esi_sdrought_summer_pre,
    z_esi_sdrought_winter_pre,
    na.rm = TRUE
  ),
  ####Pre 6. Comb. Heat (Temp + UTCI) + Drought (ESI)####
  combheatdrought_stress_index_pre = idx_invcov(
    z_temp_shockdays_summer_pre,
    z_temp_shockdays_winter_pre,
    z_temp_avgmean_summer_pre,
    z_temp_avgmean_winter_pre,
    z_temp_heatwave_days_n_pre,
    z_temp_wdays30_n_pre,
    z_utci_shockdays_summer_pre,
    z_utci_shockdays_winter_pre,
    z_utci_heatstress_n_pre,
    z_esi_mdrought_summer_pre,
    z_esi_mdrought_winter_pre,
    z_esi_sdrought_summer_pre,
    z_esi_sdrought_winter_pre,
    na.rm = TRUE
  ),
  ####Pre 7. Heat + Drought + Distance to water####
  heatdroughtdistance_index_pre = idx_invcov(
    z_temp_shockdays_summer_pre,
    z_temp_shockdays_winter_pre,
    z_temp_avgmean_summer_pre,
    z_temp_avgmean_winter_pre,
    z_temp_heatwave_days_n_pre,
    z_temp_wdays30_n_pre,
    z_esi_mdrought_summer_pre,
    z_esi_mdrought_winter_pre,
    z_esi_sdrought_summer_pre,
    z_esi_sdrought_winter_pre,
    z_distance_nile_metres,
    z_distance_waterway_metres,
    na.rm = TRUE
  ),
  ####Pre 8. Heat (Temp + UTCI) + Drought + Distance to water####
  combheatdroughtdistance_index_pre = idx_invcov(
    z_temp_shockdays_summer_pre,
    z_temp_shockdays_winter_pre,
    z_temp_avgmean_summer_pre,
    z_temp_avgmean_winter_pre,
    z_temp_heatwave_days_n_pre,
    z_temp_wdays30_n_pre,
    z_utci_shockdays_summer_pre,
    z_utci_shockdays_winter_pre,
    z_utci_heatstress_n_pre,
    z_esi_mdrought_summer_pre,
    z_esi_mdrought_winter_pre,
    z_esi_sdrought_summer_pre,
    z_esi_sdrought_winter_pre,
    z_distance_nile_metres,
    z_distance_waterway_metres,
    na.rm = TRUE
  ),
  ####Pre 9.Climate Unpredictability (sd)####
  unpredictability_index_pre = idx_invcov(
    z_temp_sd_max_summer_pre,
    z_temp_sd_max_winter_pre,
    z_temp_sd_min_summer_pre,
    z_temp_sd_min_winter_pre,
    z_esi_sd_summer_pre,
    z_esi_sd_winter_pre,
    na.rm = TRUE
  )
) |>
# 2015-2024 indices -------------------------------------------------------
mutate(
    ####2015-2024  1.Heat Stress Index ####
    heat_stress_index_15_24 = idx_invcov(
      z_temp_shockdays_summer_20152024,
      z_temp_shockdays_winter_20152024,
      z_temp_avgmean_summer_20152024,
      z_temp_avgmean_winter_20152024,
      z_temp_mean_growth_summer,
      z_temp_mean_growth_winter,
      z_temp_heatwave_days_n_20152024,
      z_temp_wdays30_n_20152024,
      na.rm = TRUE
    ),
    ###2015-2024  2. Combined Heat Stress Index- Temp. + UTCI ####
    heat_stress_index_comb_15_24 = idx_invcov(
      z_temp_shockdays_summer_20152024,
      z_temp_shockdays_winter_20152024,
      z_temp_avgmean_summer_20152024,
      z_temp_avgmean_winter_20152024,
      z_temp_heatwave_days_n_20152024,
      z_temp_wdays30_n_20152024,
      z_utci_shockdays_summer_20152024,
      z_utci_shockdays_winter_20152024,
      z_utci_heatstress_n_20152024,
      na.rm = TRUE
    ),
    ####2015-2024  3. Drought Stress Index – ESI only####
    drought_stress_index_esi_15_24 = idx_invcov(
      z_esi_mdrought_summer_20152024,
      z_esi_mdrought_winter_20152024,
      z_esi_sdrought_summer_20152024,
      z_esi_sdrought_winter_20152024,
      na.rm = TRUE
    ),
    ####2015-2024  4. Ext. Drought Stress Index – ESI + NDVI ####
    drought_stress_index_comb_15_24 = idx_invcov(
      z_esi_mdrought_summer_20152024,
      z_esi_mdrought_winter_20152024,
      z_esi_sdrought_summer_20152024,
      z_esi_sdrought_winter_20152024,
      z_ndvi_shockmonths_summer_20152024,
      z_ndvi_shockmonths_winter_20152024,
      na.rm = TRUE
    ),
    ####2015-2024  5.Heat + Drought (Temp + ESI) ####
    heatdrought_stress_index_15_24 = idx_invcov(
      z_temp_shockdays_summer_20152024,
      z_temp_shockdays_winter_20152024,
      z_temp_avgmean_summer_20152024,
      z_temp_avgmean_winter_20152024,
      z_temp_mean_growth_summer,
      z_temp_mean_growth_winter,
      z_temp_heatwave_days_n_20152024,
      z_temp_wdays30_n_20152024,
      z_esi_mdrought_summer_20152024,
      z_esi_mdrought_winter_20152024,
      z_esi_sdrought_summer_20152024,
      z_esi_sdrought_winter_20152024,
      na.rm = TRUE
    ),
    ####2015-2024  6. Comb. Heat (Temp + UTCI) + Drought (ESI)####
    combheatdrought_stress_index_15_24 = idx_invcov(
      z_temp_shockdays_summer_20152024,
      z_temp_shockdays_winter_20152024,
      z_temp_avgmean_summer_20152024,
      z_temp_avgmean_winter_20152024,
      z_temp_heatwave_days_n_20152024,
      z_temp_wdays30_n_20152024,
      z_utci_shockdays_summer_20152024,
      z_utci_shockdays_winter_20152024,
      z_utci_heatstress_n_20152024,
      z_esi_mdrought_summer_20152024,
      z_esi_mdrought_winter_20152024,
      z_esi_sdrought_summer_20152024,
      z_esi_sdrought_winter_20152024,
      na.rm = TRUE
    ),
    ####2015-2024  7.Heat + Drought + Distance to water####
    heatdroughtdistance_index_15_24 = idx_invcov(
      z_temp_shockdays_summer_20152024,
      z_temp_shockdays_winter_20152024,
      z_temp_avgmean_summer_20152024,
      z_temp_avgmean_winter_20152024,
      z_temp_mean_growth_summer,
      z_temp_mean_growth_winter,
      z_temp_heatwave_days_n_20152024,
      z_temp_wdays30_n_20152024,
      z_esi_mdrought_summer_20152024,
      z_esi_mdrought_winter_20152024,
      z_esi_sdrought_summer_20152024,
      z_esi_sdrought_winter_20152024,
      z_distance_nile_metres,
      z_distance_waterway_metres,
      na.rm = TRUE
    ),
    ####2015-2024  8. Heat (Temp + UTCI) + Drought + Distance to water ####
    combheatdroughtdistance_index_15_24 = idx_invcov(
      z_temp_shockdays_summer_20152024,
      z_temp_shockdays_winter_20152024,
      z_temp_avgmean_summer_20152024,
      z_temp_avgmean_winter_20152024,
      z_temp_heatwave_days_n_20152024,
      z_temp_wdays30_n_20152024,
      z_utci_shockdays_summer_20152024,
      z_utci_shockdays_winter_20152024,
      z_utci_heatstress_n_20152024,
      z_esi_mdrought_summer_20152024,
      z_esi_mdrought_winter_20152024,
      z_esi_sdrought_summer_20152024,
      z_esi_sdrought_winter_20152024,
      z_distance_nile_metres,
      z_distance_waterway_metres,
      na.rm = TRUE
    ),
    ####2015-2024  9. Climate Unpredictability (sd) (2015-2024)####
    unpredictability_index_15_24 = idx_invcov(
      z_temp_sd_max_summer_20152024,
      z_temp_sd_max_winter_20152024,
      z_temp_sd_min_summer_20152024,
      z_temp_sd_min_winter_20152024,
      z_esi_sd_summer_20152024,
      z_esi_sd_winter_20152024,
      na.rm = TRUE
    )
  ) |>
# 2020-2024 indices -------------------------------------------------------
#3.Create 2020-2024 indices
mutate(
  ####2020-2024 1. Heat Stress Index (2020-2024)####
  heat_stress_index_20_24 = idx_invcov(
    z_temp_shockdays_summer_20202024,
    z_temp_shockdays_winter_20202024,
    z_temp_avgmean_summer_20202024,
    z_temp_avgmean_winter_20202024,
    z_temp_mean_growth_summer,
    z_temp_mean_growth_winter,
    z_temp_heatwave_days_n_20202024,
    z_temp_wdays30_n_20202024,
    na.rm = TRUE
  ),
  ###2020-2024 2. Combined Heat Stress Index (2020-2024) - Temp. + UTCI ####
  heat_stress_index_comb_20_24  = idx_invcov(
    z_temp_shockdays_summer_20202024,
    z_temp_shockdays_winter_20202024,
    z_temp_avgmean_summer_20202024,
    z_temp_avgmean_winter_20202024,
    z_temp_heatwave_days_n_20202024,
    z_temp_wdays30_n_20202024,
    z_utci_shockdays_summer_20202024,
    z_utci_shockdays_winter_20202024,
    z_utci_heatstress_n_20202024,
    na.rm = TRUE
  ),
  ####2020-2024 3. Drought Stress Index – ESI only (2020-2024)####
  drought_stress_index_esi_20_24 = idx_invcov(
    z_esi_mdrought_summer_20202024,
    z_esi_mdrought_winter_20202024,
    z_esi_sdrought_summer_20202024,
    z_esi_sdrought_winter_20202024,
    na.rm = TRUE
  ),
  ####2020-2024 4. Ext. Drought Stress Index – ESI + NDVI (2020-2024)####
  drought_stress_index_comb_20_24 = idx_invcov(
    z_esi_mdrought_summer_20202024,
    z_esi_mdrought_winter_20202024,
    z_esi_sdrought_summer_20202024,
    z_esi_sdrought_winter_20202024,
    z_ndvi_shockmonths_summer_20202024,
    z_ndvi_shockmonths_winter_20202024,
    na.rm = TRUE
  ),
  ####2020-2024 5. Heat + Drought (Temp + ESI) (2020-2024)####
  heatdrought_stress_index_20_24 = idx_invcov(
    z_temp_shockdays_summer_20202024,
    z_temp_shockdays_winter_20202024,
    z_temp_avgmean_summer_20202024,
    z_temp_avgmean_winter_20202024,
    z_temp_mean_growth_summer,
    z_temp_mean_growth_winter,
    z_temp_heatwave_days_n_20202024,
    z_temp_wdays30_n_20202024,
    z_esi_mdrought_summer_20202024,
    z_esi_mdrought_winter_20202024,
    z_esi_sdrought_summer_20202024,
    z_esi_sdrought_winter_20202024,
    na.rm = TRUE
  ),
  ####2020-2024 6. Comb. Heat (Temp + UTCI) + Drought (ESI)####
  combheatdrought_stress_index_20_24 = idx_invcov(
    z_temp_shockdays_summer_20202024,
    z_temp_shockdays_winter_20202024,
    z_temp_avgmean_summer_20202024,
    z_temp_avgmean_winter_20202024,
    z_temp_heatwave_days_n_20202024,
    z_temp_wdays30_n_20202024,
    z_utci_shockdays_summer_20202024,
    z_utci_shockdays_winter_20202024,
    z_utci_heatstress_n_20202024,
    z_esi_mdrought_summer_20202024,
    z_esi_mdrought_winter_20202024,
    z_esi_sdrought_summer_20202024,
    z_esi_sdrought_winter_20202024,
    na.rm = TRUE
  ),
  ####2020-2024 7. Heat + Drought + Distance to water (2020-2024)####
  heatdroughtdistance_index_20_24 = idx_invcov(
    z_temp_shockdays_summer_20202024,
    z_temp_shockdays_winter_20202024,
    z_temp_avgmean_summer_20202024,
    z_temp_avgmean_winter_20202024,
    z_temp_mean_growth_summer,
    z_temp_mean_growth_winter,
    z_temp_heatwave_days_n_20202024,
    z_temp_wdays30_n_20202024,
    z_esi_mdrought_summer_20202024,
    z_esi_mdrought_winter_20202024,
    z_esi_sdrought_summer_20202024,
    z_esi_sdrought_winter_20202024,
    z_distance_nile_metres,
    z_distance_waterway_metres,
    na.rm = TRUE
  ),
  ####2020-2024 8. Heat (Temp + UTCI) + Drought + Distance to water (2020-2024)####
  combheatdroughtdistance_index_20_24 = idx_invcov(
    z_temp_shockdays_summer_20202024,
    z_temp_shockdays_winter_20202024,
    z_temp_avgmean_summer_20202024,
    z_temp_avgmean_winter_20202024,
    z_temp_heatwave_days_n_20202024,
    z_temp_wdays30_n_20202024,
    z_utci_shockdays_summer_20202024,
    z_utci_shockdays_winter_20202024,
    z_utci_heatstress_n_20202024,
    z_esi_mdrought_summer_20202024,
    z_esi_mdrought_winter_20202024,
    z_esi_sdrought_summer_20202024,
    z_esi_sdrought_winter_20202024,
    z_distance_nile_metres,
    z_distance_waterway_metres,
    na.rm = TRUE
  ),
  ####2020-2024 9. Climate Unpredictability (sd) (2020-2024)####
  unpredictability_index_20_24 = idx_invcov(
    z_temp_sd_max_summer_20202024,
    z_temp_sd_max_winter_20202024,
    z_temp_sd_min_summer_20202024,
    z_temp_sd_min_winter_20202024,
    z_esi_sd_summer_20202024,
    z_esi_sd_winter_20202024,
    na.rm = TRUE
  )
)

#select indices
hh_indices <- hh_indices |>
  dplyr::select(hhid,agglom_id,contains("index"))

#summary
skimr::skim(hh_indices)

#Standardising Indices -------------------------------------------------
hh_indices_std <- hh_indices |>
  mutate(across(
    c(
      heat_stress_index_pre:unpredictability_index_20_24),
    \(x) as.numeric(scale(x)))  # overwrite with z-standardized values
  )

#summary of std. indices
skimr::skim(hh_indices_std)

####Testing Correlations####
hh_indices_std |>
  dplyr::select(contains("index")) |>
  cor(use = "pairwise.complete.obs") |> round(2)

#rename variables to make compatible with STATA naming requirements
hh_indices_std <- hh_indices_std |>
  rename_with(
    ~ str_replace(., "combheat", "c_heat"),
    .cols = heat_stress_index_pre:last_col()
  )

#rename variables to make compatible with STATA naming requirements
hh_indices_std <- hh_indices_std |>
  rename_with(
    ~ str_replace(., "distance", "dist"),
    .cols = heat_stress_index_pre:last_col()
  )

# Label the Index Variables -----------------------------------------------
#using labelled package
hh_indices_std <- hh_indices_std |>
  set_variable_labels(
    #Pretreatment period (2000 - 2019)
    heat_stress_index_pre = "Heat Stress Index (Air Temp.) 2000-2019",
    heat_stress_index_comb_pre = "Combined Heat Stress Index (Air Temp. + UTCI) 2000-2019",
    drought_stress_index_esi_pre = "Drought Stress Index (ESI) 2000-2019",
    drought_stress_index_comb_pre = "Combined Drought Stress Index (ESI + NDVI) 2000-2019",
    heatdrought_stress_index_pre = "Heat (Air Temp.) + Drought Stress Index (ESI) 2000-2019",
    c_heatdrought_stress_index_pre = "Combined heat (Air Temp. + UTCI) + Drought Stress Index (ESI) 2000-2019",
    heatdroughtdist_index_pre = "Heat (Air Temp.) + Drought Stress (ESI) + Distance from Water Index 2000-2019",
    c_heatdroughtdist_index_pre = "Combined heat (Air Temp. + UTCI) + Drought Stress (ESI) + Distance from Water Index 2000-2019",
    unpredictability_index_pre = "Unpredictability Index (SD of Air Temp. + ESI) 2000-2019",
    #2015 - 2024 period
    heat_stress_index_15_24 = "Heat Stress Index (Air Temp.) 2015-2024",
    heat_stress_index_comb_15_24 = "Combined Heat Stress Index (Air Temp. + UTCI) 2015-2024",
    drought_stress_index_esi_15_24 = "Drought Stress Index (ESI) 2015-2024",
    drought_stress_index_comb_15_24 = "Combined Drought Stress Index (ESI + NDVI) 2015-2024",
    heatdrought_stress_index_15_24 = "Heat (Air Temp.) + Drought Stress Index (ESI) 2015-2024",
    c_heatdrought_stress_index_15_24 = "Combined heat (Air Temp. + UTCI) + Drought Stress Index (ESI) 2015-2024",
    heatdroughtdist_index_15_24 = "Heat (Air Temp.) + Drought Stress (ESI) + Distance from Water Index 2015-2024",
    c_heatdroughtdist_index_15_24 = "Combined heat (Air Temp. + UTCI) + Drought Stress (ESI) + Distance from Water Index 2015-2024",
    unpredictability_index_15_24 = "Unpredictability Index (SD of Air Temp. + ESI) 2015-2024",
    #2020 - 2024 period
    heat_stress_index_20_24 = "Heat Stress Index (Air Temp.) 2020-2024",
    heat_stress_index_comb_20_24 = "Combined Heat Stress Index (Air Temp. + UTCI) 2020-2024",
    drought_stress_index_esi_20_24 = "Drought Stress Index (ESI) 2020-2024",
    drought_stress_index_comb_20_24 = "Combined Drought Stress Index (ESI + NDVI) 2020-2024",
    heatdrought_stress_index_20_24 = "Heat (Air Temp.) + Drought Stress Index (ESI) 2020-2024",
    c_heatdrought_stress_index_20_24 = "Combined heat (Air Temp. + UTCI) + Drought Stress Index (ESI) 2020-2024",
    heatdroughtdist_index_20_24 = "Heat (Air Temp.) + Drought Stress (ESI) + Distance from Water Index 2020-2024",
    c_heatdroughtdist_index_20_24 = "Combined heat (Air Temp. + UTCI) + Drought Stress (ESI) + Distance from Water Index 2020-2024",
    unpredictability_index_20_24 = "Unpredictability Index (SD of Air Temp. + ESI) 2020-2024")

# Save Data ------------------------------------------------------------
saveRDS(hh_indices_std, file = paste(here(),"Data","final",
                                     "hh_indices.Rds",sep = "/"))
haven::write_dta(hh_indices_std,path = paste(here(),"Data","final",
                                     "hh_indices.dta",sep = "/"))



